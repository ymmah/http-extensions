<!DOCTYPE html>
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"><title>Using Early Data in HTTP</title><script type="application/javascript">
function anchorRewrite() {
  map = { };
  if (window.location.hash.length >= 1) {
    var fragid = window.location.hash.substr(1);
    if (fragid) {
      if (! document.getElementById(fragid)) {
        var prefix = "rfc.";
        var mapped = map[fragid];
        if (mapped) {
          window.location.hash = mapped;
        } else if (fragid.indexOf("section-") == 0) {
          window.location.hash = prefix + "section." + fragid.substring(8);
        } else if (fragid.indexOf("appendix-") == 0) {
          window.location.hash = prefix + "section." + fragid.substring(9);
        } else if (fragid.indexOf("s-") == 0) {
          var postfix = fragid.substring(2);
          if (postfix.startsWith("abstract")) {
            window.location.hash = prefix + postfix;
          } else if (postfix.startsWith("note-")) {
            window.location.hash = prefix + "note." + postfix.substring(5);
          } else {
            window.location.hash = prefix + "section." + postfix;
          }
        } else if (fragid.indexOf("p-") == 0) {
          var r = fragid.substring(2);
          var p = r.indexOf("-");
          if (p >= 0) {
            window.location.hash = prefix + "section." + r.substring(0, p) + ".p." + r.substring(p + 1);
          }
        }
      }
    }  
  }
}
window.addEventListener('hashchange', anchorRewrite);
window.addEventListener('DOMContentLoaded', anchorRewrite);
</script>
<style type="text/css">/*<![CDATA[*/
@viewport {
  zoom: 1.0;
  width: extend-to-zoom;
}
@-ms-viewport {
  width: extend-to-zoom;
  zoom: 1.0;
}

@media screen and (min-width: 1024px) {
  body>ul.toc, body>#rfc\.toc {
    position: fixed;
    bottom: 0;
    right: 0;
    right: calc(50vw - 550px);
    width: 300px;
    z-index: 1;
  }
  #rfc\.toc {
    top: 55px;
    overflow: auto;
    overscroll-behavior: contain;
  }
  ul.toc, #rfc\.toc {
    overflow: auto;
    overscroll-behavior: contain;
  }
  body>ul.toc {
    top: 140px;
  }

  body {
    padding-right: 350px;
  }
}

body {
  font: 16px "Helvetica Neue",Helvetica,Arial,sans-serif;
  color: #333;
  font-size-adjust: 0.5;
  line-height: 24px;
  margin: 75px auto;
  max-width: 724px;
}

.title, .filename, h1, h2, h3, h4 {
  font-family: "Helvetica Neue",Helvetica,Arial,sans-serif;
  font-size-adjust: 0.5;
  font-weight: 500;
  color: #333;
  line-height: 100%;
  margin: 0.8em 0 0.3em;
}
.title { font-size: 36px; }
h1 { font-size: 36px; }
h2 { font-size: 24px; }
h3, h4 { font-size: 18px; }
h1 a[href], h2 a[href], h3 a[href], h4 a[href] {
  color: #333;
}

ul.toc li {
  list-style: none;
  text-indent: -2.5em;
  padding-left: 2.5em;
  padding-bottom: 5px;
  margin: 0;
}
ul.toc ul {
  margin: 0;
}
/* xml2rfc nests ul directly inside ul which messes with the style badly */
ul.toc, ul.toc>ul, ul.toc ul>ul {
  margin: 0 0 0 1.5em;
}

table {
  margin-left: 0em;
  border-collapse: collapse;
}
th {
  text-align: left;
  border-bottom: 2px solid #ddd;
}
td {
  border-top: 1px solid #ddd;
  vertical-align: top;
}
tr:nth-child(2n+1) > td,
tr:nth-child(2n+1) > th {
  background-color: #f9f9f9;
}
td.reference {
  max-width: 200px;
  border-top: none;
  padding-right: 1em;
}
.right {
  text-align: right;
}


table.header {
  width: 100%;
}
table.header td {
  border: none;
  background-color: transparent;
  color: black;
}
.filename {
  color: rgb(119, 119, 119);
  font-size: 23px;
  font-weight: normal;
  height: auto;
  line-height: 100%;
}
#rfc\.abstract+p, #rfc\.abstract p {
  font-size: 18px;
  line-height: 27px%;
}

samp, tt, code, pre {
  font: 11pt consolas, monospace;
  font-size-adjust: none;
}
pre {
  background-color: #eee;
  border: 1px solid #ddd;
  overflow-x: auto;
  padding: 5px;
  margin: 5px;
}
.figure {
  font-style: italic;
  margin: 0 1.5em;
}

address {
  margin: 10px 0 0;
}
.vcard {
  font-style: normal;
}
.vcardline {
  display: block;
}
.vcardline .fn {
  font-weight: bold;
}
.vcardline .hidden {
  display: none;
}

dl {
  margin-left: 1em;
}
dl.dl-horizontal: {
  margin-left: 0;
}
dl > dt {
  float: left;
  margin-right: 1em;
}
dl.nohang > dt {
  float: none;
}
dl > dd {
  margin-bottom: .5em;
}
dl.compact > dd {
  margin-bottom: 0em;
}
dl > dd > dl {
  margin-top: 0.5em;
  margin-bottom: 0em;
}
ul.empty {
  list-style-type: none;
}
ul.empty li {
  margin-top: .5em;
}

hr {
  border: 0;
  border-top: 1px solid #eee;
}
hr.noprint {
  display: none;
}

a {
  text-decoration: none;
}
a[href] {
  color: #2a6496;
}
a[href]:hover {
  background-color: #eee;
}

ol, ul, li, p {
  padding: 0;
  margin: 0.5em 0 0.5em 2em;
}
li, p {
  margin-left: 0;
}
address {
  font-style: normal;
}

.github-fork-ribbon-wrapper {
  display: none;
}
@media screen and (min-width: 800px) {
  /* "Fork me on GitHub" CSS ribbon based on
   * https://github.com/simonwhitaker/github-fork-ribbon-css
   */
  .github-fork-ribbon {
    position: absolute;
    padding: 2px 0;
    background-color: #a00;
    background-image: linear-gradient(to bottom, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.15));
    box-shadow: 0 2px 3px 0 rgba(0, 0, 0, 0.5);
    font: 700 12px "Helvetica Neue", Helvetica, Arial, sans-serif;

    pointer-events: auto;

    top: 38px;
    right: -45px;

    transform: rotate(45deg);
  }

  .github-fork-ribbon a[href],
  .github-fork-ribbon a[href]:hover {
    color: #fff;
    background-color: transparent;
    text-decoration: none;
    text-shadow: 0 -1px rgba(0, 0, 0, 0.5);
    text-align: center;

    width: 190px;
    line-height: 18px;

    display: inline-block;
    padding: 2px 0;

    border: 1.5px dotted #fff;
    border-color: rgba(255, 255, 255, 0.6);
  }

  .github-fork-ribbon-wrapper {
    display: block;
    width: 130px;
    height: 130px;
    position: absolute;
    overflow: hidden;
    top: 0; right: 0;
    z-index: 2;
    pointer-events: none;
  }
}
@media screen and (min-width: 1000px) {
  .github-fork-ribbon-wrapper {
    position: fixed;
  }
  /*]]>*/</style>
<link rel="Contents" href="#rfc.toc"><link rel="Author" href="#rfc.authors"><link rel="Copyright" href="#rfc.copyrightnotice"><link rel="Chapter" title="1 Introduction" href="#rfc.section.1"><link rel="Chapter" title="2 Early Data in HTTP" href="#rfc.section.2"><link rel="Chapter" title="3 Supporting Early Data in HTTP Servers" href="#rfc.section.3"><link rel="Chapter" title="4 Using Early Data in HTTP Clients" href="#rfc.section.4"><link rel="Chapter" title="5 Extensions for Early Data in HTTP" href="#rfc.section.5"><link rel="Chapter" title="6 Security Considerations" href="#rfc.section.6"><link rel="Chapter" title="7 IANA Considerations" href="#rfc.section.7"><link rel="Chapter" href="#rfc.section.8" title="8 References"><link rel="Appendix" title="Acknowledgments" href="#rfc.section.unnumbered-1"><meta name="generator" content="http://greenbytes.de/tech/webdav/rfc2629.xslt, Revision 1.995, 2018/02/11 11:19:36, XSLT vendor: libxslt http://xmlsoft.org/XSLT/"><meta name="keywords" content="Internet-Draft"><link rel="schema.dcterms" href="http://purl.org/dc/terms/"><meta name="dcterms.creator" content="Thomson, M."><meta name="dcterms.creator" content="Nottingham, M."><meta name="dcterms.creator" content="Tarreau, W."><meta name="dcterms.identifier" content="urn:ietf:id:draft-ietf-httpbis-replay-latest"><meta name="dcterms.issued" content="2018-02-16"><meta name="dcterms.abstract" content="Using TLS early data creates an exposure to the possibility of a replay attack. This document defines mechanisms that allow clients to communicate with servers about HTTP requests that are sent in early data. Techniques are described that use these mechanisms to mitigate the risk of replay."><meta name="description" content="Using TLS early data creates an exposure to the possibility of a replay attack. This document defines mechanisms that allow clients to communicate with servers about HTTP requests that are sent in early data. Techniques are described that use these mechanisms to mitigate the risk of replay."></head><body><header><table class="header" id="rfc.headerblock"><tbody><tr><td class="left">HTTP Working Group</td><td class="right">M. Thomson</td></tr><tr><td class="left">Internet-Draft</td><td class="right">Mozilla</td></tr><tr><td class="left">Intended status: Standards Track</td><td class="right">M. Nottingham</td></tr><tr><td class="left">Expires: August 20, 2018</td><td class="right">Fastly</td></tr><tr><td class="left"></td><td class="right">W. Tarreau</td></tr><tr><td class="left"></td><td class="right">HAProxy Technologies</td></tr><tr><td class="left"></td><td class="right">February 16, 2018</td></tr></tbody></table><div id="rfc.title"><h1>Using Early Data in HTTP</h1><div class="filename">draft-ietf-httpbis-replay-latest</div></div></header><section id="rfc.abstract"><h2><a href="#rfc.abstract">Abstract</a></h2><div id="rfc.abstract.p.1"><p>Using TLS early data creates an exposure to the possibility of a replay attack. This document defines mechanisms that allow clients to communicate with servers about HTTP requests that are sent in early data. Techniques are described that use these mechanisms to mitigate the risk of replay.</p></div></section><section id="rfc.note.1" class="note"><h2><a href="#rfc.note.1">Note to Readers</a></h2><div id="rfc.note.1.p.1"><p>Discussion of this draft takes place on the HTTP working group mailing list (ietf-http-wg@w3.org), which is archived at <a href="https://lists.w3.org/Archives/Public/ietf-http-wg/">https://lists.w3.org/Archives/Public/ietf-http-wg/</a>.</p></div><div id="rfc.note.1.p.2"><p>Working Group information can be found at <a href="http://httpwg.github.io/">http://httpwg.github.io/</a>; source code and issues list for this draft can be found at <a href="https://github.com/httpwg/http-extensions/labels/replay">https://github.com/httpwg/http-extensions/labels/replay</a>.</p></div></section><section id="rfc.status"><h2><a href="#rfc.status">Status of this Memo</a></h2><div id="rfc.boilerplate.1.p.1"><p>This Internet-Draft is submitted in full conformance with the provisions of BCP 78 and BCP 79.</p></div><div id="rfc.boilerplate.1.p.2"><p>Internet-Drafts are working documents of the Internet Engineering Task Force (IETF). Note that other groups may also distribute working documents as Internet-Drafts. The list of current Internet-Drafts is at <a href="http://datatracker.ietf.org/drafts/current/">http://datatracker.ietf.org/drafts/current/</a>.</p></div><div id="rfc.boilerplate.1.p.3"><p>Internet-Drafts are draft documents valid for a maximum of six months and may be updated, replaced, or obsoleted by other documents at any time. It is inappropriate to use Internet-Drafts as reference material or to cite them other than as “work in progress”.</p></div><div id="rfc.boilerplate.1.p.4"><p>This Internet-Draft will expire on August 20, 2018.</p></div></section><section id="rfc.copyrightnotice"><h2><a href="#rfc.copyrightnotice">Copyright Notice</a></h2><div id="rfc.boilerplate.2.p.1"><p>Copyright © 2018 IETF Trust and the persons identified as the document authors. All rights reserved.</p></div><div id="rfc.boilerplate.2.p.2"><p>This document is subject to BCP 78 and the IETF Trust's Legal Provisions Relating to IETF Documents (<a href="http://trustee.ietf.org/license-info">http://trustee.ietf.org/license-info</a>) in effect on the date of publication of this document. Please review these documents carefully, as they describe your rights and restrictions with respect to this document. Code Components extracted from this document must include Simplified BSD License text as described in Section 4.e of the Trust Legal Provisions and are provided without warranty as described in the Simplified BSD License.</p></div></section><hr class="noprint"><nav id="rfc.toc"><h2 class="np"><a href="#rfc.toc">Table of Contents</a></h2><ul class="toc"><li><a href="#rfc.section.1">1.</a>   <a href="#introduction">Introduction</a><ul><li><a href="#rfc.section.1.1">1.1.</a>   <a href="#conventions-and-definitions">Conventions and Definitions</a></li></ul></li><li><a href="#rfc.section.2">2.</a>   <a href="#early-data-in-http">Early Data in HTTP</a></li><li><a href="#rfc.section.3">3.</a>   <a href="#supporting-early-data-in-http-servers">Supporting Early Data in HTTP Servers</a></li><li><a href="#rfc.section.4">4.</a>   <a href="#using-early-data-in-http-clients">Using Early Data in HTTP Clients</a></li><li><a href="#rfc.section.5">5.</a>   <a href="#extensions-for-early-data-in-http">Extensions for Early Data in HTTP</a><ul><li><a href="#rfc.section.5.1">5.1.</a>   <a href="#header">The Early-Data Header Field</a></li><li><a href="#rfc.section.5.2">5.2.</a>   <a href="#status">The 425 (Too Early) Status Code</a></li></ul></li><li><a href="#rfc.section.6">6.</a>   <a href="#security-considerations">Security Considerations</a><ul><li><a href="#rfc.section.6.1">6.1.</a>   <a href="#gateways-and-early-data">Gateways and Early Data</a></li><li><a href="#rfc.section.6.2">6.2.</a>   <a href="#be-consistent">Consistent Handling of Early Data</a></li><li><a href="#rfc.section.6.3">6.3.</a>   <a href="#denial-of-service">Denial of Service</a></li><li><a href="#rfc.section.6.4">6.4.</a>   <a href="#out-of-order-delivery">Out of Order Delivery</a></li></ul></li><li><a href="#rfc.section.7">7.</a>   <a href="#iana-considerations">IANA Considerations</a></li><li><a href="#rfc.section.8">8.</a>   <a href="#rfc.references">References</a><ul><li><a href="#rfc.section.8.1">8.1.</a>   <a href="#rfc.references.1">Normative References</a></li><li><a href="#rfc.section.8.2">8.2.</a>   <a href="#rfc.references.2">Informative References</a></li></ul></li><li><a href="#acknowledgments">Acknowledgments</a></li><li><a href="#rfc.authors">Authors' Addresses</a></li></ul></nav><section id="introduction"><h2 id="rfc.section.1" class="np"><a href="#rfc.section.1">1.</a> <a href="#introduction">Introduction</a></h2><div id="rfc.section.1.p.1"><p>TLS 1.3 <a href="#TLS13"><cite title="The Transport Layer Security (TLS) Protocol Version 1.3">[TLS13]</cite></a> introduces the concept of early data (also known as zero round trip data or 0-RTT data). Early data allows a client to send data to a server in the first round trip of a connection, without waiting for the TLS handshake to complete if the client has spoken to the same server recently.</p></div><div id="rfc.section.1.p.2"><p>When used with HTTP <a href="#HTTP"><cite title="Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing">[HTTP]</cite></a>, early data allows clients to send requests immediately, avoiding the one or two round trip delay needed for the TLS handshake. This is a significant performance enhancement; however, it has significant limitations.</p></div><div id="rfc.section.1.p.3"><p>The primary risk of using early data is that an attacker might capture and replay the request(s) it contains. TLS <a href="#TLS13"><cite title="The Transport Layer Security (TLS) Protocol Version 1.3">[TLS13]</cite></a> describes techniques that can be used to reduce the likelihood that an attacker can successfully replay a request, but these techniques can be difficult to deploy, and still leave some possibility of a successful attack.</p></div><div id="rfc.section.1.p.4"><p>Note that this is different from automated or user-initiated retries; replays are initiated by an attacker without the awareness of the client.</p></div><div id="rfc.section.1.p.5"><p>To help mitigate the risk of replays in HTTP, this document gives an overview of techniques for controlling these risks in servers, and defines requirements for clients when sending requests in early data.</p></div><div id="rfc.section.1.p.6"><p>The advice in this document also applies to use of 0-RTT in HTTP over QUIC <a href="#HQ"><cite title="Hypertext Transfer Protocol (HTTP) over QUIC">[HQ]</cite></a>.</p></div><section id="conventions-and-definitions"><h3 id="rfc.section.1.1"><a href="#rfc.section.1.1">1.1.</a> <a href="#conventions-and-definitions">Conventions and Definitions</a></h3><div id="rfc.section.1.1.p.1"><p>The key words “MUST”, “MUST NOT”, “REQUIRED”, “SHALL”, “SHALL NOT”, “SHOULD”, “SHOULD NOT”, “RECOMMENDED”, “NOT RECOMMENDED”, “MAY”, and “OPTIONAL” in this document are to be interpreted as described in BCP 14 <a href="#RFC2119"><cite title="Key words for use in RFCs to Indicate Requirement Levels">[RFC2119]</cite></a> <a href="#RFC8174"><cite title="Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words">[RFC8174]</cite></a> when, and only when, they appear in all capitals, as shown here.</p></div></section></section><section id="early-data-in-http"><h2 id="rfc.section.2"><a href="#rfc.section.2">2.</a> <a href="#early-data-in-http">Early Data in HTTP</a></h2><div id="rfc.section.2.p.1"><p>Conceptually, early data is concatenated with other application data to form a single stream. This can mean that requests are entirely contained within early data, or only part of a request is early. In a multiplexed protocol, like HTTP/2 <a href="#RFC7540"><cite title="Hypertext Transfer Protocol Version 2 (HTTP/2)">[RFC7540]</cite></a> or HTTP/QUIC <a href="#HQ"><cite title="Hypertext Transfer Protocol (HTTP) over QUIC">[HQ]</cite></a>, multiple requests might be partially delivered in early data.</p></div><div id="rfc.section.2.p.2"><p>The model that this document assumes is that once the TLS handshake completes, the early data received on that TLS connection is known to not be a replayed copy of that data. However, it is important to note that this does not mean that early data will not be or has not been replayed on another connection.</p></div></section><section id="supporting-early-data-in-http-servers"><h2 id="rfc.section.3"><a href="#rfc.section.3">3.</a> <a href="#supporting-early-data-in-http-servers">Supporting Early Data in HTTP Servers</a></h2><div id="rfc.section.3.p.1"><p>A server decides whether or not to offer a client the ability to send early data on future connections when sending the TLS session ticket.</p></div><div id="rfc.section.3.p.2" class="avoidbreakafter"><p>When a server enables early data, there are a number of techniques it can use to mitigate the risks of replay:</p></div><div id="rfc.section.3.p.3"><ol><li>TLS <a href="#TLS13"><cite title="The Transport Layer Security (TLS) Protocol Version 1.3">[TLS13]</cite></a> mandates the use of replay detection strategies that reduce the ability of an attacker to successfully replay early data. These anti-replay techniques reduce but don’t completely eliminate the chance of data being replayed and ensure a fixed upper limit to the number of replays.</li><li>The server can choose whether it will process early data before the TLS handshake completes. By deferring processing, it can ensure that only a successfully completed connection is used for the request(s) therein. This provides the server with some assurance that the early data was not replayed.</li><li>If the server receives multiple requests in early data, it can determine whether to defer HTTP processing on a per-request basis.</li><li>The server can cause a client to retry a request and not use early data by responding with the 425 (Too Early) status code (<a href="#status" title="The 425 (Too Early) Status Code">Section 5.2</a>), in cases where the risk of replay is judged too great.</li></ol></div><div id="rfc.section.3.p.4"><p>For a given request, the level of tolerance to replay risk is specific to the resource it operates upon (and therefore only known to the origin server). In general, if processing a request does not have state-changing side effects, the consequences of replay are not significant.</p></div><div id="rfc.section.3.p.5"><p>The request method’s safety (<a href="#RFC7231"><cite title="Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content">[RFC7231]</cite></a>, Section 4.2.1) is one way to determine this. However, some resources do elect to associate side effects with safe methods, so this cannot be universally relied upon.</p></div><div id="rfc.section.3.p.6"><p>It is RECOMMENDED that origin servers allow resources to explicitly configure whether early data is appropriate in requests. Absent such explicit information, origin servers MUST either reject early data or implement the techniques described in this document for ensuring that requests are not processed prior to TLS handshake completion.</p></div><div id="rfc.section.3.p.7"><p>A request might be sent partially in early data with the remainder of the request being sent after the handshake completes. This does not necessarily affect handling of that request; what matters is when the server starts acting upon the contents of a request. Any time any server instance might initiate processing prior to completion of the handshake, all server instances need to consider how a possible replay of early data could affect that processing (see also <a href="#be-consistent" title="Consistent Handling of Early Data">Section 6.2</a>).</p></div><div id="rfc.section.3.p.8"><p>A server can partially process requests that are incomplete. Parsing header fields - without acting on the values - and determining request routing is likely to be safe from side-effects, but other actions might not be.</p></div><div id="rfc.section.3.p.9"><p>Intermediary servers do not have sufficient information to make this determination, so <a href="#status" title="The 425 (Too Early) Status Code">Section 5.2</a> describes a way for the origin to signal to them that a particular request isn’t appropriate for early data. Intermediaries that accept early data MUST implement that mechanism.</p></div><div id="rfc.section.3.p.10"><p>Note that a server cannot choose to selectively reject early data at the TLS layer. TLS only permits a server to accept all early data, or none of it. Once a server has decided to accept early data, it MUST process all requests in early data, even if the server rejects the request by sending a 425 (Too Early) response.</p></div><div id="rfc.section.3.p.11"><p>A server can limit the amount of early data with the <span class="tt">max_early_data_size</span> field of the <span class="tt">early_data</span> TLS extension. This can be used to avoid committing an arbitrary amount of memory for deferred requests. A server SHOULD ensure that when it accepts early data, it can defer processing of requests until after the TLS handshake completes.</p></div></section><section id="using-early-data-in-http-clients"><h2 id="rfc.section.4"><a href="#rfc.section.4">4.</a> <a href="#using-early-data-in-http-clients">Using Early Data in HTTP Clients</a></h2><div id="rfc.section.4.p.1"><p>A client that wishes to use early data commences sending HTTP requests immediately after sending the TLS ClientHello.</p></div><div id="rfc.section.4.p.2"><p>By their nature, clients have control over whether a given request is sent in early data – thereby giving the client control over risk of replay. Absent other information, clients MAY send requests with safe HTTP methods (see <a href="#RFC7231"><cite title="Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content">[RFC7231]</cite></a>, Section 4.2.1) in early data when it is available, and SHOULD NOT send unsafe methods (or methods whose safety is not known) in early data.</p></div><div id="rfc.section.4.p.3"><p>If the server rejects early data at the TLS layer, a client MUST start sending again as though the connection was new. This could entail using a different negotiated protocol <a href="#ALPN"><cite title="Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension">[ALPN]</cite></a> than the one optimistically used for the early data. Any requests sent in early data MUST be sent again, unless the client decides to abandon those requests.</p></div><div id="rfc.section.4.p.4"><p>This automatic retry exposes the request to a potential replay attack. An attacker sends early data to one server instance that accepts and processes the early data, but allows that connection to proceed no further. The attacker then forwards the same messages from the client to another server instance that will reject early data. The client then retries the request, resulting in the request being processed twice. Replays are also possible if there are multiple server instances that will accept early data, or if the same server accepts early data multiple times (though this would be in violation of requirements in Section 8 of <a href="#TLS13"><cite title="The Transport Layer Security (TLS) Protocol Version 1.3">[TLS13]</cite></a>).</p></div><div id="rfc.section.4.p.5"><p>Clients that use early data MUST retry requests upon receipt of a 425 (Too Early) status code; see <a href="#status" title="The 425 (Too Early) Status Code">Section 5.2</a>.</p></div><div id="rfc.section.4.p.6"><p>An intermediary MUST NOT use early data when forwarding a request unless early data was used on a previous hop, or it knows that the request can be retried safely without consequences (typically, using out-of-band configuration). Absent better information, that means that an intermediary can only use early data if the request either arrived in early data or arrived with the <span class="tt">Early-Data</span> header field set to “1” (see <a href="#header" title="The Early-Data Header Field">Section 5.1</a>).</p></div></section><section id="extensions-for-early-data-in-http"><h2 id="rfc.section.5"><a href="#rfc.section.5">5.</a> <a href="#extensions-for-early-data-in-http">Extensions for Early Data in HTTP</a></h2><div id="rfc.section.5.p.1"><p>Because HTTP requests can span multiple “hops”, it is necessary to explicitly communicate whether a request has been sent in early data on a previous connection. Likewise, some means of explicitly triggering a retry when early data is not desirable is necessary. Finally, it is necessary to know whether the client will actually perform such a retry.</p></div><div id="rfc.section.5.p.2" class="avoidbreakafter"><p>To meet these needs, two signalling mechanisms are defined:</p></div><div id="rfc.section.5.p.3"><ul><li>The <span class="tt">Early-Data</span> header field is included in requests that might have been forwarded by an intermediary prior to the TLS handshake with its client completing.</li><li>The 425 (Too Early) status code is defined for a server to indicate that a request could not be processed due to the consequences of a possible replay attack.</li></ul></div><div id="rfc.section.5.p.4"><p>They are designed to enable better coordination of the use of early data between the user agent and origin server, and also when a gateway (also “reverse proxy”, “Content Delivery Network”, or “surrogate”) is present.</p></div><div id="rfc.section.5.p.5"><p>Gateways typically don’t have specific information about whether a given request can be processed safely when it is sent in early data. In many cases, only the origin server has the necessary information to decide whether the risk of replay is acceptable. These extensions allow coordination between a gateway and its origin server.</p></div><section id="header"><h3 id="rfc.section.5.1"><a href="#rfc.section.5.1">5.1.</a> <a href="#header">The Early-Data Header Field</a></h3><div id="rfc.section.5.1.p.1"><p>The <span class="tt">Early-Data</span> request header field indicates that the request has been conveyed in early data, and additionally indicates that a client understands the 425 (Too Early) status code.</p></div><div id="rfc.section.5.1.p.2" class="avoidbreakafter"><p>It has just one valid value: “1”. Its syntax is defined by the following ABNF <a href="#ABNF"><cite title="Augmented BNF for Syntax Specifications: ABNF">[ABNF]</cite></a>:</p></div><div id="rfc.figure.u.1"><pre class="inline">
Early-Data = "1"
</pre></div><div id="rfc.section.5.1.p.3" class="avoidbreakafter"><p>For example:</p></div><div id="rfc.figure.u.2"><pre class="text">
GET /resource HTTP/1.0
Host: example.com
Early-Data: 1

</pre></div><div id="rfc.section.5.1.p.4"><p>An intermediary that forwards a request prior to the completion of the TLS handshake with its client MUST send it with the <span class="tt">Early-Data</span> header field set to “1” (i.e., it adds it if not present in the request). An intermediary MUST use the <span class="tt">Early-Data</span> header field if it might have forwarded the request prior to handshake completion (see <a href="#be-consistent" title="Consistent Handling of Early Data">Section 6.2</a> for details).</p></div><div id="rfc.section.5.1.p.5"><p>An intermediary MUST NOT remove this header field if it is present in a request.</p></div><div id="rfc.section.5.1.p.6"><p>The <span class="tt">Early-Data</span> header field is not intended for use by user agents (that is, the original initiator of a request). Sending a request in early data implies that the client understands this specification and is willing to retry a request in response to a 425 (Too Early) status code. A user agent that sends a request in early data does not need to include the <span class="tt">Early-Data</span> header field.</p></div><div id="rfc.section.5.1.p.7"><p>A server cannot make a request that contains the Early-Data header field safe for processing by waiting for the handshake to complete. A request that is marked with Early-Data was sent in early data on a previous hop. Requests that contain the Early-Data field and cannot be safely processed MUST be rejected using the 425 (Too Early) status code.</p></div></section><section id="status"><h3 id="rfc.section.5.2"><a href="#rfc.section.5.2">5.2.</a> <a href="#status">The 425 (Too Early) Status Code</a></h3><div id="rfc.section.5.2.p.1"><p>A 425 (Too Early) status code indicates that the server is unwilling to risk processing a request that might be replayed.</p></div><div id="rfc.section.5.2.p.2"><p>User agents that send a request in early data MUST automatically retry the request when receiving a 425 (Too Early) response status code. Such retries MUST NOT be sent in early data.</p></div><div id="rfc.section.5.2.p.3"><p>In all cases, an intermediary can forward a 425 (Too Early) status code. Intermediaries MUST forward a 425 (Too Early) status code if the request that it received and forwarded contained an <span class="tt">Early-Data</span> header field. Otherwise, an intermediary that receives a request in early data MAY automatically retry that request in response to a 425 (Too Early) status code, but it MUST wait for the TLS handshake to complete on the connection where it received the request.</p></div><div id="rfc.section.5.2.p.4"><p>The server cannot assume that a client is able to retry a request unless the request is received in early data or the <span class="tt">Early-Data</span> header field is set to “1”. A server SHOULD NOT emit the 425 status code unless one of these conditions is met.</p></div><div id="rfc.section.5.2.p.5"><p>The 425 (Too Early) status code is not cacheable by default. Its payload is not the representation of any identified resource.</p></div></section></section><section id="security-considerations"><h2 id="rfc.section.6"><a href="#rfc.section.6">6.</a> <a href="#security-considerations">Security Considerations</a></h2><div id="rfc.section.6.p.1"><p>Using early data exposes a client to the risk that their request is replayed. A retried or replayed request can produce different side effects on the server. In addition to those side effects, replays and retries might be used for traffic analysis to recover information about requests or the resources those requests target.</p></div><section id="gateways-and-early-data"><h3 id="rfc.section.6.1"><a href="#rfc.section.6.1">6.1.</a> <a href="#gateways-and-early-data">Gateways and Early Data</a></h3><div id="rfc.section.6.1.p.1"><p>A gateway that forwards requests that were received in early data MUST only do so if it knows that the origin server that receives those requests understands the <span class="tt">Early-Data</span> header field and will correctly generate a 425 (Too Early) status code. A gateway that is uncertain about origin server support for a given request SHOULD either delay forwarding the request until the TLS handshake with its client completes, or send a 425 (Too Early) status code in response.</p></div><div id="rfc.section.6.1.p.2"><p>A gateway without at least one potential origin server that supports <span class="tt">Early-Data</span> header field expends significant effort for what can at best be a modest performance benefit from enabling early data. If no origin server supports early data, disabling early data entirely is more efficient.</p></div></section><section id="be-consistent"><h3 id="rfc.section.6.2"><a href="#rfc.section.6.2">6.2.</a> <a href="#be-consistent">Consistent Handling of Early Data</a></h3><div id="rfc.section.6.2.p.1"><p>Consistent treatment of a request that arrives in - or partially in - early data is critical to avoiding inappropriate processing of replayed requests. If a request is not safe to process before the TLS handshake completes, then all instances of the server (including gateways) need to agree and either reject the request or delay processing.</p></div><div id="rfc.section.6.2.p.2"><p>Disabling early data, delaying requests, or rejecting requests with the 425 (Too Early) status code are all equally good measures for mitigating replay attacks on requests that might be vulnerable to replay. Server instances can implement any of these measures and be considered to be consistent, even if different instances use different methods. Critically, this means that it is possible to employ different mitigations in reaction to other conditions, such as server load.</p></div><div id="rfc.section.6.2.p.3"><p>A server MUST NOT act on early data before the handshake completes if it and any other server instance could make a different decision about how to handle the same data.</p></div></section><section id="denial-of-service"><h3 id="rfc.section.6.3"><a href="#rfc.section.6.3">6.3.</a> <a href="#denial-of-service">Denial of Service</a></h3><div id="rfc.section.6.3.p.1"><p>Accepting early data exposes a server to potential denial of service through the replay of requests that are expensive to handle. A server that is under load SHOULD prefer rejecting TLS early data as a whole rather than accepting early data and selectively processing requests. Generating a 503 (Service Unavailable) or 425 (Too Early) status code often leads to clients retrying requests, which could result in increased load.</p></div></section><section id="out-of-order-delivery"><h3 id="rfc.section.6.4"><a href="#rfc.section.6.4">6.4.</a> <a href="#out-of-order-delivery">Out of Order Delivery</a></h3><div id="rfc.section.6.4.p.1"><p>In protocols that deliver data out of order (such as QUIC <a href="#HQ"><cite title="Hypertext Transfer Protocol (HTTP) over QUIC">[HQ]</cite></a>) early data can arrive after the handshake completes. A server MAY process requests received in early data after handshake completion if it can rely on other instances correctly handling replays of the same requests.</p></div></section></section><section id="iana-considerations"><h2 id="rfc.section.7"><a href="#rfc.section.7">7.</a> <a href="#iana-considerations">IANA Considerations</a></h2><div id="rfc.section.7.p.1"><p>This document registers the <span class="tt">Early-Data</span> header field in the “Message Headers” registry <a href="#HEADERS"><cite title="Registration Procedures for Message Header Fields">[HEADERS]</cite></a>.</p></div><div id="rfc.section.7.p.2"><dl class="compact"><dt>Header field name:</dt><dd>Early-Data</dd><dt>Applicable protocol:</dt><dd>http</dd><dt>Status:</dt><dd>standard</dd><dt>Author/Change controller:</dt><dd>IETF</dd><dt>Specification document(s):</dt><dd>This document</dd><dt>Related information:</dt><dd>(empty)</dd></dl></div><div id="rfc.section.7.p.3"><p>This document registers the 425 (Too Early) status code in the “Hypertext Transfer Protocol (HTTP) Status Code” registry established in <a href="#RFC7231"><cite title="Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content">[RFC7231]</cite></a>.</p></div><div id="rfc.section.7.p.4"><dl class="compact"><dt>Value:</dt><dd>425</dd><dt>Description:</dt><dd>Too Early</dd><dt>Reference:</dt><dd>This document</dd></dl></div></section><section id="rfc.references"><h2 id="rfc.section.8"><a href="#rfc.section.8">8.</a> References</h2><section><div id="rfc.references.1"><h3 id="rfc.section.8.1"><a href="#rfc.section.8.1">8.1.</a> Normative References</h3><dl class="reference"><dt id="ABNF">[ABNF]</dt><dd>Crocker, D., Ed. and P. Overell, “<a href="https://tools.ietf.org/html/rfc5234">Augmented BNF for Syntax Specifications: ABNF</a>”, STD 68, RFC 5234, <a href="http://dx.doi.org/10.17487/RFC5234">DOI 10.17487/RFC5234</a>, January 2008, &lt;<a href="https://www.rfc-editor.org/info/rfc5234">https://www.rfc-editor.org/info/rfc5234</a>&gt;.</dd><dt id="HEADERS">[HEADERS]</dt><dd>Klyne, G., Nottingham, M., and J. Mogul, “<a href="https://tools.ietf.org/html/rfc3864">Registration Procedures for Message Header Fields</a>”, BCP 90, RFC 3864, <a href="http://dx.doi.org/10.17487/RFC3864">DOI 10.17487/RFC3864</a>, September 2004, &lt;<a href="https://www.rfc-editor.org/info/rfc3864">https://www.rfc-editor.org/info/rfc3864</a>&gt;.</dd><dt id="HTTP">[HTTP]</dt><dd>Fielding, R., Ed. and J. Reschke, Ed., “<a href="https://tools.ietf.org/html/rfc7230">Hypertext Transfer Protocol (HTTP/1.1): Message Syntax and Routing</a>”, RFC 7230, <a href="http://dx.doi.org/10.17487/RFC7230">DOI 10.17487/RFC7230</a>, June 2014, &lt;<a href="https://www.rfc-editor.org/info/rfc7230">https://www.rfc-editor.org/info/rfc7230</a>&gt;.</dd><dt id="RFC2119">[RFC2119]</dt><dd>Bradner, S., “<a href="https://tools.ietf.org/html/rfc2119">Key words for use in RFCs to Indicate Requirement Levels</a>”, BCP 14, RFC 2119, <a href="http://dx.doi.org/10.17487/RFC2119">DOI 10.17487/RFC2119</a>, March 1997, &lt;<a href="https://www.rfc-editor.org/info/rfc2119">https://www.rfc-editor.org/info/rfc2119</a>&gt;.</dd><dt id="RFC7231">[RFC7231]</dt><dd>Fielding, R., Ed. and J. Reschke, Ed., “<a href="https://tools.ietf.org/html/rfc7231">Hypertext Transfer Protocol (HTTP/1.1): Semantics and Content</a>”, RFC 7231, <a href="http://dx.doi.org/10.17487/RFC7231">DOI 10.17487/RFC7231</a>, June 2014, &lt;<a href="https://www.rfc-editor.org/info/rfc7231">https://www.rfc-editor.org/info/rfc7231</a>&gt;.</dd><dt id="RFC8174">[RFC8174]</dt><dd>Leiba, B., “<a href="https://tools.ietf.org/html/rfc8174">Ambiguity of Uppercase vs Lowercase in RFC 2119 Key Words</a>”, BCP 14, RFC 8174, <a href="http://dx.doi.org/10.17487/RFC8174">DOI 10.17487/RFC8174</a>, May 2017, &lt;<a href="https://www.rfc-editor.org/info/rfc8174">https://www.rfc-editor.org/info/rfc8174</a>&gt;.</dd><dt id="TLS13">[TLS13]</dt><dd>Rescorla, E., “<a href="https://tools.ietf.org/html/draft-ietf-tls-tls13-22">The Transport Layer Security (TLS) Protocol Version 1.3</a>”, Internet-Draft draft-ietf-tls-tls13-22 (work in progress), November 2017.</dd></dl></div></section><section><div id="rfc.references.2"><h3 id="rfc.section.8.2"><a href="#rfc.section.8.2">8.2.</a> Informative References</h3><dl class="reference"><dt id="ALPN">[ALPN]</dt><dd>Friedl, S., Popov, A., Langley, A., and E. Stephan, “<a href="https://tools.ietf.org/html/rfc7301">Transport Layer Security (TLS) Application-Layer Protocol Negotiation Extension</a>”, RFC 7301, <a href="http://dx.doi.org/10.17487/RFC7301">DOI 10.17487/RFC7301</a>, July 2014, &lt;<a href="https://www.rfc-editor.org/info/rfc7301">https://www.rfc-editor.org/info/rfc7301</a>&gt;.</dd><dt id="HQ">[HQ]</dt><dd>Bishop, M., “<a href="https://tools.ietf.org/html/draft-ietf-quic-http-08">Hypertext Transfer Protocol (HTTP) over QUIC</a>”, Internet-Draft draft-ietf-quic-http-08 (work in progress), December 2017.</dd><dt id="RFC7540">[RFC7540]</dt><dd>Belshe, M., Peon, R., and M. Thomson, Ed., “<a href="https://tools.ietf.org/html/rfc7540">Hypertext Transfer Protocol Version 2 (HTTP/2)</a>”, RFC 7540, <a href="http://dx.doi.org/10.17487/RFC7540">DOI 10.17487/RFC7540</a>, May 2015, &lt;<a href="https://www.rfc-editor.org/info/rfc7540">https://www.rfc-editor.org/info/rfc7540</a>&gt;.</dd></dl></div></section></section><section id="acknowledgments"><h2 id="rfc.section.unnumbered-1"><a href="#acknowledgments">Acknowledgments</a></h2><div id="rfc.section.unnumbered-1.p.1"><p>This document was not easy to produce. The following people made substantial contributions to the quality and completeness of the document: David Benjamin, Subodh Iyengar, Benjamin Kaduk, Ilari Liusavaara, Kazuho Oku, Eric Rescorla, Kyle Rose, and Victor Vasiliev.</p></div></section><section id="rfc.authors" class="avoidbreakinside"><h2><a href="#rfc.authors">Authors' Addresses</a></h2><address><b>Martin Thomson</b><br>Mozilla<br>EMail: <a href="mailto:martin.thomson@gmail.com">martin.thomson@gmail.com</a></address><address><b>Mark Nottingham</b><br>Fastly<br>EMail: <a href="mailto:mnot@mnot.net">mnot@mnot.net</a></address><address><b>Willy Tarreau</b><br>HAProxy Technologies<br>EMail: <a href="mailto:willy@haproxy.org">willy@haproxy.org</a></address></section></body></html>
